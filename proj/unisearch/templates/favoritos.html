{% extends "base.html" %}

{% block content %}
<section class="favorites-hero">
    <div class="container">
        <h1>Os Meus Favoritos</h1>
        <p>As universidades que guardaste — acede rapidamente e gere a tua lista.</p>
    </div>
</section>

<section class="results-section favorites-page">
    <div class="results-wrapper">
        <div id="msg-login" style="display:none; text-align:center;">
            <p>Precisas de fazer login para ver os favoritos.</p>
            <a href="/login" class="btn-primary">Fazer Login</a>
        </div>

        <div id="lista-favoritos" class="results-list active">
            <p>A carregar...</p>
        </div>

    </div>
</section>


<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const userId = localStorage.getItem('userId');
        const container = document.getElementById('lista-favoritos');
        const msgLogin = document.getElementById('msg-login');

        if (!userId) {
            container.style.display = 'none';
            msgLogin.style.display = 'block';
            return;
        }

        try {
            const res = await fetch(`/api/users/${userId}/favorites`);
            const data = await res.json(); 

            container.innerHTML = '';

            const lista = data.favorites || data; 

            if (!lista || lista.length === 0) {
                container.innerHTML = '<p style="text-align:center;">Ainda não tens favoritos.</p>';
                return;
            }

            lista.forEach(fav => {
                container.innerHTML += `
                <article class="result-card" id="card-${fav.university_id}">
                    <div class="result-main-row">
                        <div>
                            <h3>${fav.name || fav.university_name}</h3>
                            <div style="margin-top: 10px; display:flex; align-items:center;">
                                <a href="/universidade/${fav.university_id}" class="result-link">Ver detalhes</a>
                                
                                <button onclick="removerFavorito('${fav.university_id}', this)" class="btn-remove">
                                    Remover
                                </button>
                            </div>
                        </div>
                    </div>
                </article>
                `;
            });

        } catch (error) {
            console.error(error);
            container.innerHTML = '<p>Erro ao carregar favoritos.</p>';
        }
    });

    async function removerFavorito(uniId, btnElement) {
        const userId = localStorage.getItem('userId');
        
        const textoOriginal = btnElement.innerText;
        
        btnElement.innerText = "A remover...";
        btnElement.disabled = true;

        try {
            const res = await fetch(`/api/users/${userId}/favorites/${uniId}`, {
                method: 'DELETE'
            });

            if (res.ok) {
                btnElement.innerText = "Removido!";
                btnElement.classList.add('success');

                setTimeout(() => {
                    const card = document.getElementById(`card-${uniId}`);
                    if (card) {
                        // Fade out
                        card.style.transition = "opacity 0.5s ease, transform 0.5s ease";
                        card.style.opacity = "0";
                        card.style.transform = "translateX(20px)";
                        
                        setTimeout(() => {
                            card.remove();
                            const container = document.getElementById('lista-favoritos');
                            if (container.children.length === 0) {
                                container.innerHTML = '<p style="text-align:center;">Ainda não tens favoritos.</p>';
                            }
                        }, 500);
                    }
                }, 800); 

            } else {
                
                btnElement.innerText = "Erro";
                setTimeout(() => {
                    btnElement.innerText = textoOriginal;
                    btnElement.disabled = false;
                }, 2000);
            }
        } catch (error) {
            console.error(error);
            btnElement.innerText = "Erro Rede";
            btnElement.disabled = false;
        }
    }
</script>
{% endblock %}